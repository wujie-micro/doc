<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>原理图 | 无界</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/doc/favicon.ico">
    <link rel="stylesheet" href="/doc/index.css">
    <meta name="description" content="极致的微前端框架">
    
    <link rel="preload" href="/doc/assets/css/0.styles.1608458c.css" as="style"><link rel="preload" href="/doc/assets/js/app.bf4d294b.js" as="script"><link rel="preload" href="/doc/assets/js/2.0d315983.js" as="script"><link rel="preload" href="/doc/assets/js/16.d5479e76.js" as="script"><link rel="prefetch" href="/doc/assets/js/10.7a191d8a.js"><link rel="prefetch" href="/doc/assets/js/11.c9d07152.js"><link rel="prefetch" href="/doc/assets/js/12.f8b633fa.js"><link rel="prefetch" href="/doc/assets/js/13.fb8d7419.js"><link rel="prefetch" href="/doc/assets/js/14.b2750f0d.js"><link rel="prefetch" href="/doc/assets/js/15.41d823ef.js"><link rel="prefetch" href="/doc/assets/js/17.65ea132f.js"><link rel="prefetch" href="/doc/assets/js/18.5d4c7b65.js"><link rel="prefetch" href="/doc/assets/js/19.bf829314.js"><link rel="prefetch" href="/doc/assets/js/20.8041a34b.js"><link rel="prefetch" href="/doc/assets/js/21.f1d5f82f.js"><link rel="prefetch" href="/doc/assets/js/22.222f29bd.js"><link rel="prefetch" href="/doc/assets/js/23.59b88eb4.js"><link rel="prefetch" href="/doc/assets/js/24.4afc06bd.js"><link rel="prefetch" href="/doc/assets/js/25.ac530083.js"><link rel="prefetch" href="/doc/assets/js/26.65abe28e.js"><link rel="prefetch" href="/doc/assets/js/27.d981dd38.js"><link rel="prefetch" href="/doc/assets/js/28.b3bb5169.js"><link rel="prefetch" href="/doc/assets/js/29.e17e6c07.js"><link rel="prefetch" href="/doc/assets/js/3.60b0f4a2.js"><link rel="prefetch" href="/doc/assets/js/4.c7be80a9.js"><link rel="prefetch" href="/doc/assets/js/5.c1bf3277.js"><link rel="prefetch" href="/doc/assets/js/6.77ffba29.js"><link rel="prefetch" href="/doc/assets/js/7.1927ace3.js"><link rel="prefetch" href="/doc/assets/js/8.83a1794d.js"><link rel="prefetch" href="/doc/assets/js/9.019da448.js">
    <link rel="stylesheet" href="/doc/assets/css/0.styles.1608458c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/doc/" class="home-link router-link-active"><!----> <span class="site-name">无界</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/doc/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/doc/api/bus.html" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/doc/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/doc/pack/" class="nav-link">
  框架封装
</a></div><div class="nav-item"><a href="https://wujie-micro.github.io/demo-main-vue/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue主应用
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://wujie-micro.github.io/demo-main-react/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react主应用
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://git.woa.com/wujie/wujie/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更新日志
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://git.woa.com/wujie/wujie" target="_blank" rel="noopener noreferrer" class="nav-link external">
  工蜂git
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/doc/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="/doc/api/bus.html" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/doc/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/doc/pack/" class="nav-link">
  框架封装
</a></div><div class="nav-item"><a href="https://wujie-micro.github.io/demo-main-vue/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue主应用
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://wujie-micro.github.io/demo-main-react/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react主应用
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://git.woa.com/wujie/wujie/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更新日志
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://git.woa.com/wujie/wujie" target="_blank" rel="noopener noreferrer" class="nav-link external">
  工蜂git
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/doc/guide/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/doc/guide/start.html" class="sidebar-link">快速上手</a></li><li><a href="/doc/guide/preload.html" class="sidebar-link">预加载</a></li><li><a href="/doc/guide/mode.html" class="sidebar-link">运行模式</a></li><li><a href="/doc/guide/sync.html" class="sidebar-link">路由同步</a></li><li><a href="/doc/guide/jump.html" class="sidebar-link">路由跳转</a></li><li><a href="/doc/guide/lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/doc/guide/communication.html" class="sidebar-link">通信系统</a></li><li><a href="/doc/guide/plugin.html" class="sidebar-link">插件系统</a></li><li><a href="/doc/guide/degrade.html" class="sidebar-link">降级处理</a></li><li><a href="/doc/guide/nest.html" class="sidebar-link">应用嵌套</a></li><li><a href="/doc/guide/share.html" class="sidebar-link">应用共享</a></li><li><a href="/doc/guide/variable.html" class="sidebar-link">全局变量</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="原理图"><a href="#原理图" class="header-anchor">#</a> 原理图</h2> <p><img src="https://vfiles.gtimg.cn/vupload/20211118/f050281637240979027.png" alt="原理"></p> <h2 id="运行图"><a href="#运行图" class="header-anchor">#</a> 运行图</h2> <p><img src="https://vfiles.gtimg.cn/vupload/20211118/f273b01637241117989.png" alt="框架"></p> <p>从上面框架运行图可以看出，子应用的<code>shadowRoot</code>和<code>iframe</code>和承载子应用的组件是解耦的，<code>iframe</code>中运行着子应用的实例<code>instance</code></p> <ul><li><p>当子应用采用<strong>保活模式</strong>时主应用切换路由，组件被销毁</p> <ul><li><p>子应用<code>shadowRoot</code>、<code>iframe</code>、<code>instance</code>都保留</p></li> <li><p>当组件重新渲染，无界则将<code>shadowRoot</code>重新插入组件容器即可，相当于一个<code>shadowRoot</code>的插拔动作</p></li></ul></li> <li><p>当子应用采用<strong>非保活模式</strong>时主应用切换路由，组件被销毁</p> <ul><li><p>子应用会调用<code>window.__WUJIE_UNMOUNT</code>销毁<code>instance</code>并清空<code>shadowRoot</code>内部所有元素，但是<code>shadowRoot</code>、<code>iframe</code>都保留</p></li> <li><p>当子应用重新渲染</p> <ul><li>无界将调用<code>window.__WUJIE_MOUNT</code>创建新<code>instance</code></li> <li>无界将子应用的<code>html</code>重新填充到<code>shadowRoot</code>内</li> <li>新<code>instance</code>会<code>mount</code>到<code>shadowRoot</code>上。</li></ul></li> <li><p>如果用户没有定义<code>window.__WUJIE_UNMOUNT</code>和<code>window.__WUJIE_MOUNT</code>，那么每次组件重新渲染，都会将<code>wujie</code>实例包括<code>shadowRoot</code>、<code>iframe</code>全部销毁，然后重新创建<code>wujie</code>实例，这样会有白屏时间</p></li></ul></li></ul> <p>思考：为什么要定义<code>window.__WUJIE_UNMOUNT</code>和<code>window.__WUJIE_MOUNT</code>这两个生命周期?</p> <h2 id="内部接口"><a href="#内部接口" class="header-anchor">#</a> 内部接口</h2> <h3 id="子应用window对象拓展"><a href="#子应用window对象拓展" class="header-anchor">#</a> 子应用<code>window</code>对象拓展</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Window</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否存在无界</span>
  __POWERED_BY_WUJIE__<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">// 子应用公共加载路径</span>
  __WUJIE_PUBLIC_PATH__<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// 子应用沙盒实例</span>
  __WUJIE<span class="token operator">:</span> WuJie<span class="token punctuation">;</span>
  <span class="token comment">// 子应用mount函数</span>
  <span class="token function-variable function">__WUJIE_MOUNT</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 子应用unmount函数</span>
  <span class="token function-variable function">__WUJIE_UNMOUNT</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="无界沙箱-sandbox"><a href="#无界沙箱-sandbox" class="header-anchor">#</a> 无界沙箱 sandbox</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">/**
 * 子应用的沙箱
 * @author damyxu
 * @since 2021-07-14
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Wujie</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/** 激活时路由地址 */</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用保活 */</span>
  alive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** window代理 */</span>
  proxy<span class="token operator">:</span> WindowProxy<span class="token punctuation">;</span>
  <span class="token comment">/** document代理 */</span>
  proxyDocument<span class="token operator">:</span> Object<span class="token punctuation">;</span>
  <span class="token comment">/** location代理 */</span>
  proxyLocation<span class="token operator">:</span> Object<span class="token punctuation">;</span>
  <span class="token comment">/** 事件中心 */</span>
  bus<span class="token operator">:</span> EventBus<span class="token punctuation">;</span>
  <span class="token comment">/** 容器 */</span>
  el<span class="token operator">:</span> HTMLElement<span class="token punctuation">;</span>
  <span class="token comment">/** js沙箱 */</span>
  iframe<span class="token operator">:</span> HTMLIFrameElement<span class="token punctuation">;</span>
  <span class="token comment">/** css沙箱 */</span>
  shadowRoot<span class="token operator">:</span> ShadowRoot<span class="token punctuation">;</span>
  <span class="token comment">/** 子应用的template */</span>
  template<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用代码替换钩子 */</span>
  <span class="token function-variable function">replace</span><span class="token operator">:</span> <span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用自定义fetch */</span>
  <span class="token function-variable function">fetch</span><span class="token operator">:</span> <span class="token punctuation">(</span>input<span class="token operator">:</span> RequestInfo<span class="token punctuation">,</span> init<span class="token operator">?</span><span class="token operator">:</span> RequestInit<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Response<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">/** js沙箱ready态 */</span>
  iframeReady<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用预加载态 */</span>
  preload<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用js执行队列 */</span>
  execQueue<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用执行标志 */</span>
  execFlag<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用mount标志 */</span>
  mountFlag<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** 路由同步标志 */</span>
  sync<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用跳转标志 */</span>
  hrefFlag<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用采用fiber模式执行 */</span>
  fiber<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/** 子应用styleSheet元素 */</span>
  styleSheetElements<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>HTMLLinkElement <span class="token operator">|</span> HTMLStyleElement<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">/** $wujie对象，提供给子应用的接口 */</span>
  provide<span class="token operator">:</span> <span class="token punctuation">{</span>
    bus<span class="token operator">:</span> EventBus<span class="token punctuation">;</span>
    shadowRoot<span class="token operator">?</span><span class="token operator">:</span> ShadowRoot <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    props<span class="token operator">?</span><span class="token operator">:</span>
      <span class="token operator">|</span> <span class="token punctuation">{</span>
          <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    location<span class="token operator">?</span><span class="token operator">:</span> Object<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">/** 激活子应用
   * 1、同步路由
   * 2、动态修改iframe的fetch
   * 3、准备shadow
   * 4、准备子应用注入
   */</span>
  <span class="token function">active</span><span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    sync<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    template<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    el<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> HTMLElement<span class="token punctuation">;</span>
    props<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    alive<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    fetch<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>input<span class="token operator">:</span> RequestInfo<span class="token punctuation">,</span> init<span class="token operator">?</span><span class="token operator">:</span> RequestInit<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Response<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    replace<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">/** 启动子应用
   * 1、运行js
   * 2、处理兼容样式
   */</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token function-variable function">getExternalScripts</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ScriptResultList<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/** 销毁子应用 */</span>
  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/** 当子应用再次激活后，只运行mount函数，样式需要重新恢复 */</span>
  <span class="token function">rebuildStyleSheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/** 兼容:root选择器样式到:host选择器上 */</span>
  <span class="token function">attachHostCssRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * @param id 子应用的id，唯一标识
   * @param url 子应用的url，可以包含protocol、host、path、query、hash
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    fiber<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="细节"><a href="#细节" class="header-anchor">#</a> 细节</h2> <h3 id="实现一个纯净的-iframe"><a href="#实现一个纯净的-iframe" class="header-anchor">#</a> 实现一个纯净的 iframe</h3> <p>子应用运行在一个和主应用同域的<code>iframe</code>中，设置<code>src</code>为替换了主域名<code>host</code>的子应用<code>url</code>，子应用路由只取<code>location</code>的<code>pathname</code>和<code>hash</code></p> <p>但是一旦设置<code>src</code>后，<code>iframe</code>由于同域，会加载主应用的<code>html</code>、<code>js</code>，所以必须在<code>iframe</code>实例化完成并且还没有加载完<code>html</code>时中断加载，防止污染子应用</p> <div class="custom-block warning"><p class="custom-block-title">提醒</p> <ul><li>如果<code>iframe</code>没有实例化完成就进行<code>stop</code>，<code>location</code>的<code>origin</code>为<code>about:blank</code>会导致子应用路由无法运行</li> <li>如果直接在 iframe 实例化时采用<code>document.write</code>擦除，路由器的同步功能将失败</li></ul></div> <p>具体实现：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">/**
 * 防止运行主应用的js代码，给子应用带来很多副作用
 */</span>
<span class="token comment">// TODO: 更加准确抓取停止时机</span>
<span class="token keyword">function</span> <span class="token function">stopIframeLoading</span><span class="token punctuation">(</span>iframeWindow<span class="token operator">:</span> Window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  iframeWindow<span class="token punctuation">.</span>__WUJIE<span class="token punctuation">.</span>iframeReady <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// location ready</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iframeWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">===</span> <span class="token string">&quot;about:blank&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          iframeWindow<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">initIframeDom</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="iframe-数据劫持和注入"><a href="#iframe-数据劫持和注入" class="header-anchor">#</a> iframe 数据劫持和注入</h3> <p>子应用的代码 <code>code</code> 在 <code>iframe</code> 内部访问 <code>window</code>、<code>location</code> 都被劫持到相应的 <code>proxy</code>，注意这个闭包只是为了修改<code>location</code>而<code>window</code>和<code>document</code>对象和原型已经被直接修改</p> <p>当采用<code>script</code>的<code>type</code>为<code>module</code>时会去除这个闭包，需要访问<code>$wujie.location</code>来获取修改后的<code>location</code></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function(window, self, global, location) {
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n
  }).bind(window.__WUJIE.proxy)(
    window.__WUJIE.proxy,
    window.__WUJIE.proxy,
    window.__WUJIE.proxy,
    window.__WUJIE.proxy.location,
  );</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><h3 id="iframe-和-shadowroot-副作用的处理"><a href="#iframe-和-shadowroot-副作用的处理" class="header-anchor">#</a> iframe 和 shadowRoot 副作用的处理</h3> <p><code>iframe</code> 内部的副作用处理在初始化<code>iframe</code>时进行，主要分为如下几部</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 1、location劫持后的数据修改回来，防止跨域错误
 * 2、同步路由到主应用
 */</span>
<span class="token function">patchIframeHistory</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">,</span> appPublicPath<span class="token punctuation">,</span> mainPublicPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 对window.addEventListener进行劫持，比如resize事件必须是监听主应用的
 */</span>
<span class="token function">patchIframeEvents</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 注入私有变量
 */</span>
<span class="token function">patchIframeVariable</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">,</span> appPublicPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 将有DOM副作用的统一在此修改，比如mutationObserver必须调用主应用的
 */</span>
<span class="token function">patchIframeDomEffect</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 子应用前进后退，同步路由到主应用
 */</span>
<span class="token function">syncIframeUrlToWindow</span><span class="token punctuation">(</span>iframeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>ShadowRoot</code> 内部的副作用必须进行处理，主要处理的就是<code>shadowRoot</code>的<code>head</code>和<code>body</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  shadowRoot<span class="token punctuation">.</span>head<span class="token punctuation">.</span>appendChild <span class="token operator">=</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">rawDOMAppendOrInsertBefore</span><span class="token operator">:</span> rawHeadAppendChild
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> rawHeadAppendChild
  shadowRoot<span class="token punctuation">.</span>head<span class="token punctuation">.</span>insertBefore <span class="token operator">=</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">rawDOMAppendOrInsertBefore</span><span class="token operator">:</span> rawHeadInsertBefore <span class="token keyword">as</span> any
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> rawHeadInsertBefore
  shadowRoot<span class="token punctuation">.</span>body<span class="token punctuation">.</span>appendChild <span class="token operator">=</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">rawDOMAppendOrInsertBefore</span><span class="token operator">:</span> rawBodyAppendChild
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> rawBodyAppendChild
  shadowRoot<span class="token punctuation">.</span>body<span class="token punctuation">.</span>insertBefore <span class="token operator">=</span> <span class="token function">getOverwrittenAppendChildOrInsertBefore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">rawDOMAppendOrInsertBefore</span><span class="token operator">:</span> rawBodyInsertBefore <span class="token keyword">as</span> any
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> rawBodyInsertBefore
</code></pre></div><p><code>getOverwrittenAppendChildOrInsertBefore</code>主要是处理四种类型标签：</p> <ul><li><p><strong><code>link/style</code>标签</strong></p> <p>收集<code>stylesheetElement</code>并用于子应用重新激活重建样式</p></li> <li><p><strong><code>script</code>标签</strong></p> <p>动态插入的<code>script</code>标签必须从<code>ShadowRoot</code>转移至<code>iframe</code>内部执行</p></li> <li><p><strong><code>iframe</code>标签</strong></p> <p>修复<code>iframe</code>的指向对应子应用<code>iframe</code>的<code>window</code></p></li></ul> <div class="custom-block tip"><p class="custom-block-title">收益</p> <ul><li><strong>js 层面、css 层面、dom 层面的副作用全部框架处理，应用接入没有适配成本</strong></li> <li><strong>副作用约束在 iframe 和 ShadowRoot 内部不会溢出</strong></li></ul></div> <h3 id="iframe-的-document-改造"><a href="#iframe-的-document-改造" class="header-anchor">#</a> iframe 的 document 改造</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>_fakeDocument<span class="token punctuation">,</span> propKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> document <span class="token operator">=</span> window<span class="token punctuation">.</span>document<span class="token punctuation">;</span>
      <span class="token keyword">const</span> shadowRoot <span class="token operator">=</span> iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>__WUJIE<span class="token punctuation">.</span>shadowRoot<span class="token punctuation">;</span>
      <span class="token comment">// need fix</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;createElement&quot;</span> <span class="token operator">||</span> propKey <span class="token operator">===</span> <span class="token string">&quot;createTextNode&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>document<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function">apply</span><span class="token punctuation">(</span>createElement<span class="token punctuation">,</span> _ctx<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>iframe<span class="token punctuation">.</span>contentDocument<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">patchElementEffect</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> element<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;documentURI&quot;</span> <span class="token operator">||</span> propKey <span class="token operator">===</span> <span class="token string">&quot;URL&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>__WUJIE<span class="token punctuation">.</span>proxyLocation <span class="token keyword">as</span> Location<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// from shadowRoot</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        propKey <span class="token operator">===</span> <span class="token string">&quot;getElementsByTagName&quot;</span> <span class="token operator">||</span>
        propKey <span class="token operator">===</span> <span class="token string">&quot;getElementsByClassName&quot;</span> <span class="token operator">||</span>
        propKey <span class="token operator">===</span> <span class="token string">&quot;getElementsByName&quot;</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>shadowRoot<span class="token punctuation">.</span>querySelectorAll<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function">apply</span><span class="token punctuation">(</span>querySelectorAll<span class="token punctuation">,</span> _ctx<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> arg <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;getElementsByClassName&quot;</span><span class="token punctuation">)</span> arg <span class="token operator">+=</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;getElementsByName&quot;</span><span class="token punctuation">)</span> arg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[name=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">querySelectorAll</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>shadowRoot<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;getElementById&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>shadowRoot<span class="token punctuation">.</span>querySelector<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function">apply</span><span class="token punctuation">(</span>querySelector<span class="token punctuation">,</span> _ctx<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">querySelector</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>shadowRoot<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;querySelector&quot;</span> <span class="token operator">||</span> propKey <span class="token operator">===</span> <span class="token string">&quot;querySelectorAll&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> shadowRoot<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>shadowRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;documentElement&quot;</span> <span class="token operator">||</span> propKey <span class="token operator">===</span> <span class="token string">&quot;scrollingElement&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> shadowRoot<span class="token punctuation">.</span>firstElementChild<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;forms&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> shadowRoot<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&quot;form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> shadowRoot<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;links&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> shadowRoot<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> ownerProperties<span class="token punctuation">,</span> shadowProperties<span class="token punctuation">,</span> shadowMethods<span class="token punctuation">,</span> documentProperties<span class="token punctuation">,</span> documentMethods <span class="token punctuation">}</span> <span class="token operator">=</span>
        documentProxyProperties<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ownerProperties<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>shadowProperties<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>propKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> shadowRoot<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shadowMethods<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>propKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getTargetValue</span><span class="token punctuation">(</span>shadowRoot<span class="token punctuation">,</span> propKey<span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token function">getTargetValue</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> propKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// from window.document</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>documentProperties<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>propKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> document<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>documentMethods<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>propKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getTargetValue</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> propKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="iframe-的-location-改造"><a href="#iframe-的-location-改造" class="header-anchor">#</a> iframe 的 location 改造</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>fakeLocation<span class="token punctuation">,</span> propKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> location <span class="token operator">=</span> target<span class="token punctuation">.</span>location<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;host&quot;</span> <span class="token operator">||</span> propKey <span class="token operator">===</span> <span class="token string">&quot;hostname&quot;</span> <span class="token operator">||</span> propKey <span class="token operator">===</span> <span class="token string">&quot;protocol&quot;</span> <span class="token operator">||</span> propKey <span class="token operator">===</span> <span class="token string">&quot;port&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> urlElement<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">.</span>location<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>mainPublicPath<span class="token punctuation">,</span> appPublicPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;reload&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;子应用调用reload无法生效&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">getTargetValue</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> propKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>location<span class="token punctuation">,</span> propKey<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是跳转链接的话重开一个iframe</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> shadowRoot<span class="token punctuation">,</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>__WUJIE<span class="token punctuation">;</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^http</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> hrefElement <span class="token operator">=</span> <span class="token function">anchorElementGenerator</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
          url <span class="token operator">=</span> appPublicPath <span class="token operator">+</span> hrefElement<span class="token punctuation">.</span>pathname <span class="token operator">+</span> hrefElement<span class="token punctuation">.</span>search <span class="token operator">+</span> hrefElement<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
          hrefElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        target<span class="token punctuation">.</span>__WUJIE<span class="token punctuation">.</span>hrefFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">renderIframeReplaceShadowRoot</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> shadowRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pushUrlToWindow</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> propKey<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/doc/assets/js/app.bf4d294b.js" defer></script><script src="/doc/assets/js/2.0d315983.js" defer></script><script src="/doc/assets/js/16.d5479e76.js" defer></script>
  </body>
</html>
